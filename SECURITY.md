# セキュリティ実装ガイド

このドキュメントは、本番環境デプロイメント用のPromptyアプリケーションに実装された包括的なセキュリティ対策について説明します。

## 🔒 実装されたセキュリティ機能

### 1. 認証と認可
- **JWT トークン検証**: 適切なエラーハンドリングによる安全なトークン検証
- **ロールベースアクセス制御（RBAC）**: 管理者、ユーザー、ゲストロール
- **セッション管理**: 自動更新機能付きの安全なセッション処理
- **パスワードセキュリティ**: 最低8文字で強度検証
- **多要素認証対応**: MFA用のインフラ準備済み

### 2. 入力検証とサニタイゼーション
- **Zod スキーマ検証**: すべての API エンドポイントに対する包括的な入力検証
- **SQL インジェクション防止**: パラメータ化クエリと入力サニタイゼーション
- **XSS 保護**: HTML サニタイゼーションとコンテンツセキュリティポリシー
- **ファイルアップロードセキュリティ**: ファイル形式検証、サイズ制限、ウイルススキャン
- **リクエストサイズ制限**: 大容量ペイロード攻撃からの保護

### 3. レート制限
- **エンドポイント固有の制限**: 認証、アップロード、決済、AI リクエストごとの異なる制限
- **IP ベースの追跡**: ユーザーエージェントフィンガープリンティングを使用した IP アドレスによるレート制限
- **スライディングウィンドウ**: 適切なリセット機能を持つ高度なレート制限
- **DDoS 保護**: 複数レイヤーのリクエスト調整

### 4. ファイルアップロードセキュリティ
- **ファイル形式検証**: 許可された MIME タイプのホワイトリスト
- **マジックナンバー検証**: スプーフィングを防ぐファイル署名検証
- **サイズ制限**: 最大ファイルサイズ 5MB
- **ウイルススキャン**: 基本的な悪意あるパターン検出（フル AV に拡張可能）
- **安全なファイル名**: 暗号学的に安全なファイル名生成
- **隔離システム**: 疑わしいファイルをレビューのために隔離

### 5. API セキュリティ
- **CORS 設定**: 厳格なオリジン検証
- **セキュリティヘッダー**: 包括的なセキュリティヘッダー実装
- **コンテンツセキュリティポリシー**: XSS とインジェクション攻撃を防ぐ厳格な CSP
- **HTTPS 強制**: 本番環境での HTTP から HTTPS へのリダイレクト
- **リクエスト検証**: すべてのリクエストをスキーマに対して検証

### 6. データベースセキュリティ
- **行レベルセキュリティ（RLS）**: Supabase RLS ポリシーの強制
- **管理者クライアント分離**: 制限された操作を持つ独立した管理者クライアント
- **クエリホワイトリスト**: 管理者操作では許可されたテーブルのみアクセス可能
- **接続セキュリティ**: データベース接続の SSL/TLS 暗号化
- **監査ログ**: セキュリティ監視のためのデータベース操作ログ

### 7. エラーハンドリング
- **安全なエラーレスポンス**: エラーメッセージに機密情報を含まない
- **構造化ログ**: 監視のための包括的なエラーログ
- **グレースフルデグラデーション**: 部分的障害時もアプリケーションは機能継続
- **セキュリティイベントログ**: すべてのセキュリティ関連イベントをログ記録

### 8. 環境セキュリティ
- **環境変数検証**: 起動時に必要な変数をチェック
- **秘密管理**: 機密データの適切な分離
- **設定検証**: セキュリティ設定の検証
- **開発 vs 本番**: 環境ごとの異なるセキュリティレベル

## 🚀 デプロイメントセキュリティチェックリスト

### デプロイ前
- [ ] すべての環境変数が設定済み
- [ ] SSL 証明書がインストール済み
- [ ] データベース RLS ポリシーが有効
- [ ] レート制限が設定済み
- [ ] ファイルアップロード制限が設定済み
- [ ] CORS オリジンが設定済み
- [ ] セキュリティヘッダーが有効
- [ ] CSP ポリシーが定義済み

### 必要な環境変数
```bash
# コアアプリケーション
NEXT_PUBLIC_URL=https://your-domain.com
NODE_ENV=production

# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Stripe
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=your_stripe_publishable_key
STRIPE_SECRET_KEY=your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=your_webhook_secret

# セキュリティ
JWT_SECRET=your_jwt_secret_32_chars_minimum
ENCRYPTION_KEY=your_encryption_key_32_chars
RATE_LIMIT_MAX=100
RATE_LIMIT_WINDOW_MS=900000

# ファイルアップロード
MAX_FILE_SIZE=5242880
ALLOWED_FILE_TYPES=image/jpeg,image/png,image/webp,image/gif
VIRUS_SCAN_ENABLED=true

# AI サービス
NEXT_PUBLIC_GEMINI_API_KEY=your_gemini_api_key
```

### デプロイ後
- [ ] セキュリティヘッダーの確認済み
- [ ] レート制限のテスト済み
- [ ] ファイルアップロード制限のテスト済み
- [ ] 認証フローのテスト済み
- [ ] エラーハンドリングの確認済み
- [ ] 監視が設定済み
- [ ] バックアップ手順が確立済み

## 🛡️ セキュリティ監視

### 監視対象メトリクス
- 認証失敗の試行
- レート制限違反
- ファイルアップロード拒否
- データベースクエリ失敗
- API エラー率
- 異常なトラフィックパターン

### アラート設定
- 同一 IP からの複数回ログイン失敗
- レート制限閾値の超過
- 疑わしいファイルアップロード
- データベース接続問題
- 高いエラー率
- セキュリティヘッダー違反

## 🔧 セキュリティ設定

### レート制限設定
```typescript
// エンドポイントごとの異なる制限
一般: 15分間に100リクエスト
認証: 15分間に10リクエスト
アップロード: 1時間に20リクエスト
決済: 1時間に5リクエスト
AI: 1時間に50リクエスト
```

### ファイルアップロードセキュリティ
```typescript
// 厳格なファイル検証
最大サイズ: 5MB
許可タイプ: JPEG、PNG、WebP、GIF のみ
ウイルススキャン: パターンベースの検出
ファイル名: 暗号学的に安全な生成
```

### コンテンツセキュリティポリシー
```
default-src 'self';
script-src 'self' 'unsafe-inline' https://js.stripe.com;
style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
img-src 'self' data: blob: https:;
connect-src 'self' https://api.stripe.com [supabase-url];
```

## 🚨 インシデント対応

### セキュリティインシデントタイプ
1. **認証バイパス**: 即座のトークン無効化とユーザー通知
2. **データ漏洩**: データベース分離と法科学的分析
3. **DDoS 攻撃**: レート制限のエスカレーションとトラフィック分析
4. **悪意あるアップロード**: ファイル隔離とユーザーアカウント確認
5. **API 悪用**: エンドポイント無効化とリクエスト分析

### 対応手順
1. **即座**: 影響を受けたシステムの分離
2. **評価**: 範囲と影響の判定
3. **封じ込め**: さらなる損害の防止
4. **復旧**: 正常な操作の復元
5. **教訓**: セキュリティ対策の更新

## 🔍 セキュリティテスト

### 自動テスト
- 入力検証テスト
- 認証フローテスト
- レート制限確認
- ファイルアップロードセキュリティテスト
- エラーハンドリング検証

### 手動テスト
- ペネトレーションテスト
- ソーシャルエンジニアリング評価
- 物理セキュリティ確認
- コードレビュー
- 設定監査

## 📚 セキュリティリソース

### ドキュメント
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Next.js セキュリティ](https://nextjs.org/docs/advanced-features/security-headers)
- [Supabase セキュリティ](https://supabase.com/docs/guides/auth/row-level-security)
- [Stripe セキュリティ](https://stripe.com/docs/security)

### ツール
- セキュリティスキャナー
- 脆弱性評価
- コード分析ツール
- 監視ソリューション
- バックアップシステム

## 🔄 定期的なセキュリティメンテナンス

### 週次
- セキュリティログの確認
- 認証失敗試行のチェック
- レート制限効果の監視
- バックアップ整合性の確認

### 月次
- 依存関係の更新
- アクセス権限の確認
- インシデント対応手順のテスト
- ユーザーアカウントの監査

### 四半期
- セキュリティ評価
- ペネトレーションテスト
- ポリシー確認
- トレーニング更新

---

**注記**: このセキュリティ実装はエンタープライズグレードの保護を提供します。セキュリティ体制を維持するために、定期的な更新と監視が不可欠です。