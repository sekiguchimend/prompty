name: CI/CD Pipeline for prompty-ai.com

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  NODE_VERSION: '18'
  DOMAIN_NAME: 'prompty-ai.com'

jobs:
  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  build-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting (with error tolerance)
      run: npm run lint || true
      
    - name: Run type checking (with error tolerance)
      run: npx tsc --noEmit || true
      
    - name: Build application
      run: |
        NODE_OPTIONS="--max-old-space-size=3072" npm run build
      env:
        SKIP_TYPE_CHECK: true
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        NEXT_PUBLIC_DOMAIN: ${{ env.DOMAIN_NAME }}

  # EC2ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  deploy-to-ec2:
    needs: build-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        port: 22
        script: |
          cd /home/ec2-user/prompty
          
          # ç¾åœ¨ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
          pm2 stop prompty || true
          
          # æœ€æ–°ã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
          git fetch origin
          git reset --hard origin/main
          
          # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm ci
          
          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰
          NODE_OPTIONS="--max-old-space-size=3072" npm run build
          
          # PM2ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•
          pm2 start ecosystem.config.js --env production || pm2 restart prompty
          
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          sleep 10
          curl -f https://prompty-ai.com || curl -f http://localhost:3000 || exit 1
          
          echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ğŸŒ ã‚¢ã‚¯ã‚»ã‚¹URL: https://prompty-ai.com"
          
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… prompty-ai.com ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸ"
          echo "ğŸŒ ã‚µã‚¤ãƒˆURL: https://prompty-ai.com"
        else
          echo "âŒ prompty-ai.com ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ã¾ã—ãŸ"
        fi 